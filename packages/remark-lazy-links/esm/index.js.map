{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { writeFileSync } from \"node:fs\";\nimport { fromMarkdown } from \"mdast-util-from-markdown\";\nimport type { Root } from \"mdast\";\nimport type { Plugin } from \"unified\";\nimport type { VFile } from \"vfile\";\n\ninterface LazyLinksOptions {\n\t/**\n\t * Whether to persist the transformed links back to source files.\n\t *\n\t * When false (default): Transformation happens in-memory only during build.\n\t * Source files remain unchanged with [*] markers.\n\t *\n\t * When true: Source files are permanently modified, replacing [*] with\n\t * numbered links. Useful if you want the transformed format to be the\n\t * canonical version or need to use files outside of Astro.\n\t *\n\t * @default false\n\t */\n\tpersist?: boolean;\n}\n\n/**\n * Finds the maximum numbered link reference in the content\n */\nfunction findMaxCounter(content: string): number {\n\tconst counterRegex = /\\[(\\d+)\\]:/g;\n\tlet maxCounter = 0;\n\tconst matches = content.matchAll(counterRegex);\n\n\tfor (const match of matches) {\n\t\tif (match[1]) {\n\t\t\tconst num = Number.parseInt(match[1], 10);\n\t\t\tif (num > maxCounter) {\n\t\t\t\tmaxCounter = num;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn maxCounter;\n}\n\n/**\n * Transforms lazy links [*] to numbered references\n */\nfunction transformLazyLinks(\n\tcontent: string,\n\tstartCounter: number,\n): {\n\ttransformed: string;\n\thasChanges: boolean;\n} {\n\tlet transformed = content;\n\tlet hasChanges = false;\n\n\t// Count total [*] occurrences\n\tconst totalMatches = (content.match(/\\[\\*\\]/g) || []).length;\n\n\tif (totalMatches === 0) {\n\t\treturn { transformed, hasChanges: false };\n\t}\n\n\t// Strategy: The first half are references, the second half are definitions\n\t// They map 1-to-1 in order\n\t//\n\t// Example input:  \"[first][*] and [second][*]\\n\\n[*]: http://first.com\\n[*]: http://second.com\"\n\t// Occurrences: 4 total, so 2 references and 2 definitions\n\t// After transform: \"[first][1] and [second][2]\\n\\n[1]: http://first.com\\n[2]: http://second.com\"\n\n\tconst halfPoint = totalMatches / 2;\n\tlet occurrenceCount = 0;\n\tlet counter = startCounter;\n\n\ttransformed = transformed.replace(/\\[\\*\\]/g, () => {\n\t\toccurrenceCount++;\n\t\thasChanges = true;\n\n\t\t// For the first half (references), increment counter\n\t\t// For the second half (definitions), use counter from corresponding reference\n\t\tif (occurrenceCount <= halfPoint) {\n\t\t\t// This is a reference\n\t\t\tcounter++;\n\t\t\treturn `[${counter}]`;\n\t\t}\n\t\t// This is a definition - use the number from (occurrenceCount - halfPoint)\n\t\tconst refNumber = startCounter + (occurrenceCount - halfPoint);\n\t\treturn `[${refNumber}]`;\n\t});\n\n\treturn { transformed, hasChanges };\n}\n\n/**\n * Persists the transformed content to the source file\n */\nfunction persistToFile(filepath: string, content: string): void {\n\ttry {\n\t\twriteFileSync(filepath, content, \"utf-8\");\n\t} catch {\n\t\t// Silently fail if file cannot be written (e.g., readonly filesystem)\n\t\t// The transformation is still applied in-memory for the build\n\t}\n}\n\n/**\n * Remark plugin to transform lazy markdown links [*] into numbered references.\n *\n * Inspired by Brett Terpstra's lazy markdown reference links:\n * http://brettterpstra.com/2013/10/19/lazy-markdown-reference-links/\n *\n * Transforms:\n *   [link text][*]  and  [*]: http://url\n * Into:\n *   [link text][1]  and  [1]: http://url\n *\n * Features:\n * - Preserves existing numbered links\n * - Handles multiple overlapping lazy links\n * - Configurable persistence (in-memory or write back to source)\n *\n * @example\n * // In-memory transformation only (default)\n * remarkPlugins: [remarkLazyLinks]\n *\n * @example\n * // Persist changes back to source files\n * remarkPlugins: [[remarkLazyLinks, { persist: true }]]\n */\nexport const remarkLazyLinks: Plugin<[LazyLinksOptions?], Root> = (\n\toptions = {},\n) => {\n\tconst { persist = false } = options;\n\n\treturn (_tree: Root, file: VFile) => {\n\t\t// This runs after parsing, but we need to work on the original text\n\t\t// The key insight: unified processes file.value through the parser\n\t\t// We need to get the ORIGINAL value before it was parsed\n\n\t\t// Get the original file contents (before parsing)\n\t\tconst originalContent = file.toString();\n\n\t\t// Check if there are any lazy links to process\n\t\tif (!originalContent.includes(\"[*]\")) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Find the maximum existing numbered link to avoid conflicts\n\t\tconst maxCounter = findMaxCounter(originalContent);\n\n\t\t// Transform lazy links to numbered links\n\t\tconst { transformed, hasChanges } = transformLazyLinks(\n\t\t\toriginalContent,\n\t\t\tmaxCounter,\n\t\t);\n\n\t\tif (!hasChanges) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If persist is enabled and changes were made, write back to source file\n\t\tif (persist) {\n\t\t\tconst filepath = file.history?.[0];\n\t\t\tif (filepath) {\n\t\t\t\tpersistToFile(filepath, transformed);\n\t\t\t}\n\t\t}\n\n\t\t// Re-parse the transformed content to get the correct AST\n\t\t// This is necessary because we modified the raw text, but the tree was already parsed\n\t\tconst newTree = fromMarkdown(transformed);\n\n\t\t// Replace the current tree's children and data with the new tree\n\t\t_tree.children = newTree.children;\n\t\tif (newTree.data) {\n\t\t\t_tree.data = newTree.data;\n\t\t}\n\t};\n};\n"]}